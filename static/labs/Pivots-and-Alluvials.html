---
title: "Pivot and Alluvial Plots"
author: "Arvind Venkatadri"
date: "2/21/2021"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<div id="examining-pivot-longer-and-pivot_wider" class="section level1">
<h1>Examining <code>pivot-longer</code> and <code>pivot_wider</code></h1>
<div id="string-data-in-column-names" class="section level2">
<h2>String Data in Column Names</h2>
<pre class="r"><code># String Data in Column Names
relig_income</code></pre>
<pre><code>## # A tibble: 18 x 11
##    religion `&lt;$10k` `$10-20k` `$20-30k` `$30-40k` `$40-50k` `$50-75k` `$75-100k`
##    &lt;chr&gt;      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;      &lt;dbl&gt;
##  1 Agnostic      27        34        60        81        76       137        122
##  2 Atheist       12        27        37        52        35        70         73
##  3 Buddhist      27        21        30        34        33        58         62
##  4 Catholic     418       617       732       670       638      1116        949
##  5 Don’t k~      15        14        15        11        10        35         21
##  6 Evangel~     575       869      1064       982       881      1486        949
##  7 Hindu          1         9         7         9        11        34         47
##  8 Histori~     228       244       236       238       197       223        131
##  9 Jehovah~      20        27        24        24        21        30         15
## 10 Jewish        19        19        25        25        30        95         69
## 11 Mainlin~     289       495       619       655       651      1107        939
## 12 Mormon        29        40        48        51        56       112         85
## 13 Muslim         6         7         9        10         9        23         16
## 14 Orthodox      13        17        23        32        32        47         38
## 15 Other C~       9         7        11        13        13        14         18
## 16 Other F~      20        33        40        46        49        63         46
## 17 Other W~       5         2         3         4         2         7          3
## 18 Unaffil~     217       299       374       365       341       528        407
## # ... with 3 more variables: $100-150k &lt;dbl&gt;, &gt;150k &lt;dbl&gt;,
## #   Don&#39;t know/refused &lt;dbl&gt;</code></pre>
<div id="how-do-we-understand-this-dataset" class="section level3">
<h3>How do we understand this dataset?</h3>
<ul>
<li>All columns are except <code>religion</code> and <code>Don't know/refused</code> are also
numerical</li>
<li>The numbers are <strong>counts</strong> i.e. aggregates, and not specific income
numbers, say</li>
<li>Anything else? We’ll see…</li>
</ul>
</div>
<div id="how-should-we-visualize-this-data-set" class="section level3">
<h3>How should we visualize this data set?</h3>
<ul>
<li>religion vs income?</li>
</ul>
<pre class="r"><code>ggplot(relig_income, aes(x =`&lt;$10k`, y = religion)) + geom_col() + labs(title = &quot;People with Low Income across Religion&quot;)</code></pre>
<p><img src="/labs/Pivots-and-Alluvials_files/figure-html/religion_vs_income-1.png" width="672" /></p>
<p>What if I want to see counts of different income levels within the same
religion? Let’s try…</p>
<pre class="r"><code>ggplot(relig_income) +
  geom_col(aes(y = religion, x = `&lt;$10k`)) + 
  geom_col(aes(y = religion, x = `$10-20k`)) + 
  geom_col(aes(y = religion, x = `$20-30k`)) +
  labs(title = &quot;People with...different incomes, across religion&quot;, subtitle = &quot;It ain&#39;t happening...&quot;)</code></pre>
<p><img src="/labs/Pivots-and-Alluvials_files/figure-html/trying_piled_up_column_charts-1.png" width="672" /></p>
<pre class="r"><code>  #...and so on....</code></pre>
<p>It’s not working, is it?</p>
<p>We want a <code>stack</code>ed or <code>dodge</code>d bar chart with <code>religion</code> on one axis
and <code>counts of people</code> on the other…so where is the problem?</p>
<p>The data has:</p>
<ol style="list-style-type: lower-alpha">
<li><strong>string data</strong> in columns names. These strings are a…. <strong>set of categories</strong> ( of income) and therefore are “levels” of a <strong><em>factor</em></strong> !! We need them, these column titles, in one new factor column !</li>
<li>So the data is the *<strong>wrong shape</strong> !! It’s “too wide”…</li>
</ol>
<p>We need to have:
- religion
- income range ( aha, a factor!!)
- count</p>
<p>Three columns. Bas!! Then we plot count and colour by income and we are
done !</p>
</div>
<div id="enter-the-pivot_longer" class="section level3">
<h3>Enter the pivot_longer</h3>
<pre class="r"><code>relig_income_long &lt;- relig_income %&gt;% pivot_longer(data = .,
                              cols = !religion,
                              names_to = &quot;income_range&quot;,
                              values_to = &quot;count&quot;)
relig_income_long</code></pre>
<pre><code>## # A tibble: 180 x 3
##    religion income_range       count
##    &lt;chr&gt;    &lt;chr&gt;              &lt;dbl&gt;
##  1 Agnostic &lt;$10k                 27
##  2 Agnostic $10-20k               34
##  3 Agnostic $20-30k               60
##  4 Agnostic $30-40k               81
##  5 Agnostic $40-50k               76
##  6 Agnostic $50-75k              137
##  7 Agnostic $75-100k             122
##  8 Agnostic $100-150k            109
##  9 Agnostic &gt;150k                 84
## 10 Agnostic Don&#39;t know/refused    96
## # ... with 170 more rows</code></pre>
<pre class="r"><code># From vignette(&quot;pivot&quot;)
#The first argument is the dataset to reshape, relig_income.
#The second argument describes which columns need to be reshaped. In this case, it’s every column apart from religion.
#The names_to gives the name of the variable that will be created from the data stored in the column names, i.e. income_range.
#The values_to gives the name of the variable that will be created from the data stored in the cell value, i.e. count.
#Neither the names_to nor the values_to column exists in relig_income, so we provide them as character strings surrounded in quotes.</code></pre>
<pre class="r"><code>relig_income_long %&gt;% 
  ggplot(aes(y = religion, x = count, fill = income_range)) + 
  geom_col(position = &quot;stack&quot;, color = &quot;black&quot;)</code></pre>
<p><img src="/labs/Pivots-and-Alluvials_files/figure-html/relig_income_long_plot-1.png" width="672" /></p>
</div>
</div>
<div id="numeric-data-in-column-names" class="section level2">
<h2><strong>numeric data</strong> in column names</h2>
<pre class="r"><code>billboard</code></pre>
<pre><code>## # A tibble: 317 x 79
##    artist   track   date.entered   wk1   wk2   wk3   wk4   wk5   wk6   wk7   wk8
##    &lt;chr&gt;    &lt;chr&gt;   &lt;date&gt;       &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
##  1 2 Pac    Baby D~ 2000-02-26      87    82    72    77    87    94    99    NA
##  2 2Ge+her  The Ha~ 2000-09-02      91    87    92    NA    NA    NA    NA    NA
##  3 3 Doors~ Krypto~ 2000-04-08      81    70    68    67    66    57    54    53
##  4 3 Doors~ Loser   2000-10-21      76    76    72    69    67    65    55    59
##  5 504 Boyz Wobble~ 2000-04-15      57    34    25    17    17    31    36    49
##  6 98^0     Give M~ 2000-08-19      51    39    34    26    26    19     2     2
##  7 A*Teens  Dancin~ 2000-07-08      97    97    96    95   100    NA    NA    NA
##  8 Aaliyah  I Don&#39;~ 2000-01-29      84    62    51    41    38    35    35    38
##  9 Aaliyah  Try Ag~ 2000-03-18      59    53    38    28    21    18    16    14
## 10 Adams, ~ Open M~ 2000-08-26      76    76    74    69    68    67    61    58
## # ... with 307 more rows, and 68 more variables: wk9 &lt;dbl&gt;, wk10 &lt;dbl&gt;,
## #   wk11 &lt;dbl&gt;, wk12 &lt;dbl&gt;, wk13 &lt;dbl&gt;, wk14 &lt;dbl&gt;, wk15 &lt;dbl&gt;, wk16 &lt;dbl&gt;,
## #   wk17 &lt;dbl&gt;, wk18 &lt;dbl&gt;, wk19 &lt;dbl&gt;, wk20 &lt;dbl&gt;, wk21 &lt;dbl&gt;, wk22 &lt;dbl&gt;,
## #   wk23 &lt;dbl&gt;, wk24 &lt;dbl&gt;, wk25 &lt;dbl&gt;, wk26 &lt;dbl&gt;, wk27 &lt;dbl&gt;, wk28 &lt;dbl&gt;,
## #   wk29 &lt;dbl&gt;, wk30 &lt;dbl&gt;, wk31 &lt;dbl&gt;, wk32 &lt;dbl&gt;, wk33 &lt;dbl&gt;, wk34 &lt;dbl&gt;,
## #   wk35 &lt;dbl&gt;, wk36 &lt;dbl&gt;, wk37 &lt;dbl&gt;, wk38 &lt;dbl&gt;, wk39 &lt;dbl&gt;, wk40 &lt;dbl&gt;,
## #   wk41 &lt;dbl&gt;, wk42 &lt;dbl&gt;, wk43 &lt;dbl&gt;, wk44 &lt;dbl&gt;, wk45 &lt;dbl&gt;, wk46 &lt;dbl&gt;,
## #   wk47 &lt;dbl&gt;, wk48 &lt;dbl&gt;, wk49 &lt;dbl&gt;, wk50 &lt;dbl&gt;, wk51 &lt;dbl&gt;, wk52 &lt;dbl&gt;,
## #   wk53 &lt;dbl&gt;, wk54 &lt;dbl&gt;, wk55 &lt;dbl&gt;, wk56 &lt;dbl&gt;, wk57 &lt;dbl&gt;, wk58 &lt;dbl&gt;,
## #   wk59 &lt;dbl&gt;, wk60 &lt;dbl&gt;, wk61 &lt;dbl&gt;, wk62 &lt;dbl&gt;, wk63 &lt;dbl&gt;, wk64 &lt;dbl&gt;,
## #   wk65 &lt;dbl&gt;, wk66 &lt;lgl&gt;, wk67 &lt;lgl&gt;, wk68 &lt;lgl&gt;, wk69 &lt;lgl&gt;, wk70 &lt;lgl&gt;,
## #   wk71 &lt;lgl&gt;, wk72 &lt;lgl&gt;, wk73 &lt;lgl&gt;, wk74 &lt;lgl&gt;, wk75 &lt;lgl&gt;, wk76 &lt;lgl&gt;</code></pre>
<p>Here the columns <code>starting_with</code> “wk” are actually *<strong>numeric columns</strong>, corresponding to the week number after the song entered the charts.</p>
<p>The number is the rank of a song in each of the weeks it spent on the charts!!</p>
<p>So we can do this:</p>
<pre class="r"><code>billboard %&gt;% 
  pivot_longer(
    cols = starts_with(&quot;wk&quot;), 
    names_to = &quot;week&quot;, 
    values_to = &quot;rank&quot;,
    values_drop_na = TRUE
  )</code></pre>
<pre><code>## # A tibble: 5,307 x 5
##    artist  track                   date.entered week   rank
##    &lt;chr&gt;   &lt;chr&gt;                   &lt;date&gt;       &lt;chr&gt; &lt;dbl&gt;
##  1 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26   wk1      87
##  2 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26   wk2      82
##  3 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26   wk3      72
##  4 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26   wk4      77
##  5 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26   wk5      87
##  6 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26   wk6      94
##  7 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26   wk7      99
##  8 2Ge+her The Hardest Part Of ... 2000-09-02   wk1      91
##  9 2Ge+her The Hardest Part Of ... 2000-09-02   wk2      87
## 10 2Ge+her The Hardest Part Of ... 2000-09-02   wk3      92
## # ... with 5,297 more rows</code></pre>
<pre class="r"><code>billboard %&gt;% 
  pivot_longer(
    cols = starts_with(&quot;wk&quot;), 
    names_to = &quot;week&quot;, 
    names_prefix = &quot;wk&quot;,
    names_transform = list(week = as.integer),
    values_to = &quot;rank&quot;,
    values_drop_na = TRUE,
  )</code></pre>
<pre><code>## # A tibble: 5,307 x 5
##    artist  track                   date.entered  week  rank
##    &lt;chr&gt;   &lt;chr&gt;                   &lt;date&gt;       &lt;int&gt; &lt;dbl&gt;
##  1 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26       1    87
##  2 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26       2    82
##  3 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26       3    72
##  4 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26       4    77
##  5 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26       5    87
##  6 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26       6    94
##  7 2 Pac   Baby Don&#39;t Cry (Keep... 2000-02-26       7    99
##  8 2Ge+her The Hardest Part Of ... 2000-09-02       1    91
##  9 2Ge+her The Hardest Part Of ... 2000-09-02       2    87
## 10 2Ge+her The Hardest Part Of ... 2000-09-02       3    92
## # ... with 5,297 more rows</code></pre>
</div>
<div id="we-can-stop-here--d" class="section level2">
<h2>WE CAN STOP HERE ;-D</h2>
</div>
<div id="many-variables-in-column-names" class="section level2">
<h2>Many variables in column names</h2>
<pre class="r"><code>who</code></pre>
<pre><code>## # A tibble: 7,240 x 60
##    country  iso2  iso3   year new_sp_m014 new_sp_m1524 new_sp_m2534 new_sp_m3544
##    &lt;chr&gt;    &lt;chr&gt; &lt;chr&gt; &lt;int&gt;       &lt;int&gt;        &lt;int&gt;        &lt;int&gt;        &lt;int&gt;
##  1 Afghani~ AF    AFG    1980          NA           NA           NA           NA
##  2 Afghani~ AF    AFG    1981          NA           NA           NA           NA
##  3 Afghani~ AF    AFG    1982          NA           NA           NA           NA
##  4 Afghani~ AF    AFG    1983          NA           NA           NA           NA
##  5 Afghani~ AF    AFG    1984          NA           NA           NA           NA
##  6 Afghani~ AF    AFG    1985          NA           NA           NA           NA
##  7 Afghani~ AF    AFG    1986          NA           NA           NA           NA
##  8 Afghani~ AF    AFG    1987          NA           NA           NA           NA
##  9 Afghani~ AF    AFG    1988          NA           NA           NA           NA
## 10 Afghani~ AF    AFG    1989          NA           NA           NA           NA
## # ... with 7,230 more rows, and 52 more variables: new_sp_m4554 &lt;int&gt;,
## #   new_sp_m5564 &lt;int&gt;, new_sp_m65 &lt;int&gt;, new_sp_f014 &lt;int&gt;,
## #   new_sp_f1524 &lt;int&gt;, new_sp_f2534 &lt;int&gt;, new_sp_f3544 &lt;int&gt;,
## #   new_sp_f4554 &lt;int&gt;, new_sp_f5564 &lt;int&gt;, new_sp_f65 &lt;int&gt;,
## #   new_sn_m014 &lt;int&gt;, new_sn_m1524 &lt;int&gt;, new_sn_m2534 &lt;int&gt;,
## #   new_sn_m3544 &lt;int&gt;, new_sn_m4554 &lt;int&gt;, new_sn_m5564 &lt;int&gt;,
## #   new_sn_m65 &lt;int&gt;, new_sn_f014 &lt;int&gt;, new_sn_f1524 &lt;int&gt;,
## #   new_sn_f2534 &lt;int&gt;, new_sn_f3544 &lt;int&gt;, new_sn_f4554 &lt;int&gt;,
## #   new_sn_f5564 &lt;int&gt;, new_sn_f65 &lt;int&gt;, new_ep_m014 &lt;int&gt;,
## #   new_ep_m1524 &lt;int&gt;, new_ep_m2534 &lt;int&gt;, new_ep_m3544 &lt;int&gt;,
## #   new_ep_m4554 &lt;int&gt;, new_ep_m5564 &lt;int&gt;, new_ep_m65 &lt;int&gt;,
## #   new_ep_f014 &lt;int&gt;, new_ep_f1524 &lt;int&gt;, new_ep_f2534 &lt;int&gt;,
## #   new_ep_f3544 &lt;int&gt;, new_ep_f4554 &lt;int&gt;, new_ep_f5564 &lt;int&gt;,
## #   new_ep_f65 &lt;int&gt;, newrel_m014 &lt;int&gt;, newrel_m1524 &lt;int&gt;,
## #   newrel_m2534 &lt;int&gt;, newrel_m3544 &lt;int&gt;, newrel_m4554 &lt;int&gt;,
## #   newrel_m5564 &lt;int&gt;, newrel_m65 &lt;int&gt;, newrel_f014 &lt;int&gt;,
## #   newrel_f1524 &lt;int&gt;, newrel_f2534 &lt;int&gt;, newrel_f3544 &lt;int&gt;,
## #   newrel_f4554 &lt;int&gt;, newrel_f5564 &lt;int&gt;, newrel_f65 &lt;int&gt;</code></pre>
<p>The columns from <code>new_sp_m014</code> to <code>newrel_f65</code> encode <strong>four variables</strong> in their <strong>names</strong>:</p>
<ul>
<li><p>The <code>new_/new</code> prefix indicates these are counts of new cases. (This dataset only contains new cases, so we’ll ignore it here because it’s constant.)</p></li>
<li><p><code>sp/rel/ep</code> describe how the case was diagnosed.</p></li>
<li><p><code>m/f</code> gives the gender.</p></li>
<li><p><code>014/1524/2535/3544/4554/65</code> supplies the age range.</p></li>
</ul>
<p>So how do we deal with this dataset using <code>pivot_longer(0)</code>?</p>
</div>
</div>
