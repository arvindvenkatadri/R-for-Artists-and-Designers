---
title: "Pivot and Alluvial Plots"
author: "Arvind Venkatadri"
date: "2/21/2021"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

# Examining `pivot-longer` and `pivot_wider`

## String Data in Column Names

```{r relig_income_data}
# String Data in Column Names
relig_income
```

### How do we understand this dataset?

-   All columns are except `religion` and `Don't know/refused` are also
    numerical
-   The numbers are **counts** i.e. aggregates, and not specific income
    numbers, say
-   Anything else? We'll see...

### How should we visualize this data set?

-   religion vs income?

```{r religion_vs_income}
ggplot(relig_income, aes(x =`<$10k`, y = religion)) + geom_col() + labs(title = "People with Low Income across Religion")
```

What if I want to see counts of different income levels within the same
religion? Let's try...

```{r trying_piled_up_column_charts}
ggplot(relig_income) +
  geom_col(aes(y = religion, x = `<$10k`)) + 
  geom_col(aes(y = religion, x = `$10-20k`)) + 
  geom_col(aes(y = religion, x = `$20-30k`)) +
  labs(title = "People with...different incomes, across religion", subtitle = "It ain't happening...")
  #...and so on....
```

It's not working, is it?

We want a `stack`ed or `dodge`d bar chart with `religion` on one axis
and `counts of people` on the other...so where is the problem?

The data has:

a)  **string data** in columns names. These strings are a.... **set of categories** ( of income) and therefore are "levels" of a ***factor*** !! We need them, these column titles, in one new factor column !
b)  So the data is the ***wrong shape** !! It's "too wide"...

We need to have:
- religion
- income range ( aha, a factor!!)
- count

Three columns. Bas!! Then we plot count and colour by income and we are
done !

### Enter the pivot_longer

```{r pivot_longer_relig_income}
relig_income_long <- relig_income %>% pivot_longer(data = .,
                              cols = !religion,
                              names_to = "income_range",
                              values_to = "count")
relig_income_long


# From vignette("pivot")
#The first argument is the dataset to reshape, relig_income.
#The second argument describes which columns need to be reshaped. In this case, it’s every column apart from religion.
#The names_to gives the name of the variable that will be created from the data stored in the column names, i.e. income_range.
#The values_to gives the name of the variable that will be created from the data stored in the cell value, i.e. count.
#Neither the names_to nor the values_to column exists in relig_income, so we provide them as character strings surrounded in quotes.
```

```{r relig_income_long_plot}
relig_income_long %>% 
  ggplot(aes(y = religion, x = count, fill = income_range)) + 
  geom_col(position = "stack", color = "black")
```


## **numeric data** in column names

```{r}
billboard
```

Here the columns `starting_with` "wk" are actually ***numeric columns**, corresponding to the week number after the song entered the charts.

The number is the rank of a song in each of the weeks it spent on the charts!!

So we can do this:

```{r}
billboard %>% 
  pivot_longer(
    cols = starts_with("wk"), 
    names_to = "week", 
    values_to = "rank",
    values_drop_na = TRUE
  )
```


```{r}
billboard %>% 
  pivot_longer(
    cols = starts_with("wk"), 
    names_to = "week", 
    names_prefix = "wk",
    names_transform = list(week = as.integer),
    values_to = "rank",
    values_drop_na = TRUE,
  )
```

## WE CAN STOP HERE ;-D

## Many variables in column names


```{r}
who
```

The columns from `new_sp_m014` to `newrel_f65` encode **four variables** in their **names**:

- The `new_/new` prefix indicates these are counts of new cases. (This dataset only contains new cases, so we’ll ignore it here because it’s constant.)

- `sp/rel/ep` describe how the case was diagnosed.

- `m/f` gives the gender.

- `014/1524/2535/3544/4554/65` supplies the age range.

So how do we deal with this dataset using `pivot_longer(0)`?
