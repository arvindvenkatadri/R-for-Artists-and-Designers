---
title: "Lab-06: The Grammar of Maps"
subtitle: "Which is your native?"
author: "Arvind Venkatadri"
date: 22/April/2021
output:
  html_document:
    theme: flatly
    toc: TRUE
    toc_float: TRUE
    toc_depth: 2
    number_sections: TRUE
    code_download: TRUE
abstract: Part of the `R for Artists and Designers` course at the School of Foundation Studies, Srishti Manipal Institute of Art, Design, and Technology, Bangalore.
---

# Goals

At the end of this Lab session, we should:
- know the types and structures of `spatial data` and be able to work with them
- understand the basics of modern spatial packages in R
- be able to specify and download spatial data from the web, using R
- plot *static* and *interactive* maps using `ggplot`, `tmap` and `leaflet` packages
- add symbols and markers for places and regions of our own interest in these maps.
- see directions for further work (e.g. maps + networks together)


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Getting Map Data into R
library(osmdata) # Import Open Street Data
library(rnaturalearth)

library(prettymapr) # to search for map data based on location

# Plotting Maps
library(tidyverse) # Maps using ggplot + geom_sf
library(osmplotr) # "Bespoke" Maps using OSM data
library(tmap) # Thematic Maps, static and interactive

# For Spatial Data Frame Processing
library(sf)
```

## Introduction to Maps in R

We will take small steps in making maps using just two of the several map making packages in R.

The steps we will use are:

1. Search for an area of interest ( E.g. using `prettymapr` or similar..)
2. Learn how to access spatial/map data using `osmdata`
3. Plot and dress up our map using `osmplot`, `tmap` and also with `leaflet`.
4. Create interactive maps with `leaflet` using a variety of map data providers. Note: `tmap` can also do interactive maps which we will explore also. 

Bas. Onwards and Map-wards!!


## God made me a BengaluR-kaR...I think

Let's get BLR data into R and see if we can plot an area of interest. Then we can order on Swiggy and...never mind. 

Where is my home? Specify a "bounding box" first, using a rough longitude latitude info directly, or using a place name to search for the long/lat info:

```{r I_am_going_home}
# BLR Bounding Box
# get_bbox needs lat and lon ranges
bbox <- osmplotr::get_bbox(c(77.56,12.93,77.63,12.96))

bbox_l <- osmdata::getbb("Bangalore, India") # LARGE
bbox_p <- prettymapr::searchbbox("Bangalore") # ALSO LARGE
bbox
bbox_l
bbox_p # identical with bbox_l
```

```{r get_osm_map_data, cache = TRUE, message=FALSE}
# Get Map data

dat_B <- extract_osm_objects (key = "building", bbox = bbox) 
dat_H <- extract_osm_objects (key = 'highway', bbox = bbox)
dat_P <- extract_osm_objects (key = 'park', bbox = bbox)
dat_G <- extract_osm_objects (key = 'landuse', value = 'grass', bbox = bbox)
dat_T <- extract_osm_objects (key = 'natural', value = 'tree', bbox = bbox)

# Useful keys include building, place, amenity, shop, waterway, natural, boundary, and highway.


```
## Let's look at the data
```{r}
# How many buildings?
nrow(dat_B)
dat_B$geometry
class(dat_B$geometry)
```
So `dat_B` has `r nrow(dat_B)` buildings and their geometry is naturally a POLYGON type of geometry column. 

Do this check for all the other spatial data.

```{r YOUR_TURN_1}

```

## YOUR_COMMENTS_1





## My first Map in R

We could quickly plot this using the package `osmplotr`. However, in my ( i.e. Arvind's opinion ) it is not as flexible as other packages. Maybe I need to study it in more detail. 

So we will continue with `ggplot`:

```{r}

blr_map <- ggplot() +
  geom_sf(data = dat_B, colour = "orange") +  # POLYGONS
  geom_sf(data = dat_H, col = "gray20") +     # LINES
  geom_sf(data = dat_G, col = "darkseagreen1") + 
  geom_sf(data = dat_P, col = "darkseagreen") +
  geom_sf(data = dat_T, col = "green")        # POINTS
blr_map


```


Note how `geom_sf` is capable of handling *any* geometry in the `sfc` column !! 
> `geom_sf()` is an unusual geom because it will draw different geometric objects depending on what simple features are present in the data: you can get points, lines, or polygons.


## Adding my favourite "area" to the map

We can create areas of interest around the map. 
For a start: we are simply going to *zoom in* to an area and say that is our area of interest. 
This area then needs to go **Through the Looking Glass** and become part of the projection of `dat_B`!!

We can then try based on your favourite restaurants etc. 

```{r shapes_on_maps}

my_area <- bbox %>% 
  
  # zooming in within our bounding box area
  prettymapr::zoombbox(factor = 8, offset = c(0,0)) 
my_area
bbox
```

OK, `my area` is smalled and contained inside my `bbox`. So zoom works. Now to convert `my_area` into a spatial dataframe using `sf` and add it to the `blr_map` plot:

```{r}
my_area_in_blr <- matrix(
  c(
  my_area["x", "min"],
  my_area["x", "max"],
  my_area["x", "max"],
  my_area["x", "min"],
  my_area["x", "min"],
  my_area["y", "min"],
  my_area["y", "min"],
  my_area["y", "max"],
  my_area["y", "max"],
  my_area["y", "min"]),
  ncol = 2) %>% # Make a matrix
  
  list() %>% # Convert to list since POLYGON needs a list
  
  st_polygon() %>% # Convert to POLYGON
  
  st_sfc(., crs = st_crs(dat_B)) %>% # Convert POLYGON to an `sfc`
  # Through the Looking Glass with dat_B
  
  st_as_sf(.) # Convert sfc to an sf spatial dataframe. Phew!!
  


my_area_in_blr
```


```{r My_Blr_finally}
blr_map <- 
  blr_map + geom_sf(data = my_area_in_blr, colour = "red")
blr_map

```

## Adding my favourite "points" to the map
Is it time to order on Swiggy...

Let us adding interesting places to our map: say based on your favourite restaurants etc. We need restaurant data: lat/long + name + maybe type of restaurant. This can be manually created ( like all of OSMdata ) or if it is already there we can download using *key-value* pairs in our OSM data query.

```{r restaurant_data_1}
dat_R <- extract_osm_objects(bbox = bbox, key = "amenity", value = "restaurant", return_type = "point")
```

```{r restaurant_data_2}
# How many restaurants have we got?
dat_R %>% nrow()
```

```{r restaurant_data_3}
names(dat_R)
# Let's look at the `cuisine` column! 
# ( I want pizza...)
dat_R$cuisine
```
So let us plot the restaurants as POINTs using the `dat-R` data we have downloaded. The `cuisine` attribute looks interesting; let us colour the POINT based on the `cuisine` offered at that restaurant. 

```{r}
dat_R <- dat_R %>% 
  drop_na(cuisine) %>% # Knock off nondescript restaurants
  
  # Some have more than on classification ;-()
  # Separated by semicolon or comma, so....
  separate(col = cuisine, into = c("cuisine", NA, NA), sep = ";") %>% 
  separate(col = cuisine, into = c("cuisine", NA, NA), sep = ",")

# Finally good food?
dat_R$cuisine
```

Now let's plot the Restaurants as POINTs:

```{r}
# http://www.stat.columbia.edu/~tzheng/files/Rcolor.pdf
# 
ggplot() + 
  geom_sf(data = dat_B, colour = "burlywood1") + 
  geom_sf(data = dat_H, colour = "gray80") +
  geom_sf(data = dat_R %>% drop_na(cuisine), aes(fill = cuisine), colour = "black", shape = 21) + 
  theme(legend.position = "right") +
  labs(title = "Restaurants in South Central Bangalore",
       caption = "Based on osmdata")
```
We could have done a (much!) better job, by combining cuisines into simpler and fewer categories, but that is for another day!! 

Let's go meet the Gryphon and the Mock Turtle...carrying this Pig!

![](images/11.jpg)

## Using `rnaturalearth` and `tmap`



```{r World_Data}
data("World")
data("metro")

head(metro, n = 3)
```


```{r My Static World}
tmap_mode("plot")

# Group 1
tm_shape(World) +
    tm_polygons("HPI") +
# Group 2
tm_shape(metro) + 
  tm_bubbles(size = "pop2020", col = "red")
```



```{r My Interactive Water Colour World}
tmap_mode("view")

tm_shape(World) +
    tm_polygons("HPI") +
tm_shape(metro) + 
  tm_bubbles(size = "pop2020", col = "red") +
tm_tiles("Stamen.TonerLabels")
```


```{r spatial_data}
india <- 
  ne_states(country =  "india", 
            geounit = "india", 
            returnclass = "sf")

india_neighbours <- 
  ne_states(country = (c("india", "sri lanka", "pakistan",
                         "afghanistan", "nepal","bangladesh")
                       )
            )

names(india)
names(india_neighbours)
```


## Subsetting Spatial data by attributes

```{r Spatial_data_subsetting_by_attributes}
#ind <- metro$iso_a3 == "IND"
#metro_ind1 <- metro[ind,]
metro_ind2 <- subset(metro, iso_a3 == "IND")
metro_neighbours <- metro %>% dplyr::filter(iso_a3 %in% c("IND","PAK", "LKA", "BGD","NPL"))
```

## Map 1
```{r Map_1}
tm_shape(World %>% dplyr::filter(iso_a3 %in% c("IND", "AFG", "PAK", "NPL", "BGD", "LKA"))) + 
  tm_borders() + 
tm_shape(india) + 
  tm_polygons("name") + 
  tm_shape(metro_ind2)+
  tm_dots(size = "pop2020") + 
  tm_layout(legend.outside = TRUE,legend.outside.position = "right") +
  tm_credits("Geographical Boundaries are not accurate",size = 0.5,position = "right") + 
  tm_compass(position = c("right", "top")) + 
  tm_scale_bar(position = "left") + 
  tmap_style("watercolor") #cobalt #gray #white #col_blind #beaver #classic #watercolor #albatross #bw
```



## Map 2
```{r Map_2}
tm_shape(india_neighbours) + 
  tm_polygons("name") + 
  tm_shape(metro_neighbours) +
  tm_dots(size = "pop2020") + 
  tm_layout(legend.outside = TRUE,legend.outside.position = "right") +
  tmap_options(max.categories = 10) + 
  tm_credits("Geographical Boundaries are not accurate",size = 0.5,position = "center")
```

```{r}
tmap_mode("plot")
tm_basemap("Stamen.Watercolor") +
  tm_shape(metro, bbox = "India") + 
  tm_dots(col = "red", 
          # user-chosen group name for layers
          group = "Metropolitan Areas") +
  tm_shape(World) + 
  tm_borders() + 
  tm_tiles(server = "Stamen.TonerLabels",group = "Labels") + # ADDS LABELS!!!
  tm_graticules()

```


# Scope and Packages for Exploration!!

### sfnetworks
### mapsf
### ggspatial


# Resources

1. Emine Fidan, [Guide to Creating Interactive Maps in R](https://bookdown.org/eneminef/DRR_Bookdown/)

2. Nikita Voevodin,[R, Not the Best Practices](https://bookdown.org/voevodin_nv/R_Not_the_Best_Practices/maps.html)


# Assignments

1. What if we have marked our favourite locations on our smartphones, using GPS? Umm...OK have to make our sf:Spatial Data Frame using these coordinates. 
We will need to do this in the same way:
- Create a matrix
- Make POINTs
- Make an sfc
- Convert to sf
- Project in the same way. 

Draw a map of your home-town with your favourite restaurants shown. Pop-ups for each restaurant will win bonus points. 

