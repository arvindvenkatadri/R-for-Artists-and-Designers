---
title: "Alluvial"
author: "Arvind Venkatadri"
date: "16/07/2019"
output: html_document
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<div id="uc-berkeley-admissions-dataset." class="section level2">
<h2>UC Berkeley Admissions dataset.</h2>
<p>Do we see a case for gender bias in admissions?</p>
<p>Following this vignette:
<a href="https://cran.r-project.org/web/packages/ggalluvial/vignettes/ggalluvial.html" class="uri">https://cran.r-project.org/web/packages/ggalluvial/vignettes/ggalluvial.html</a></p>
<pre class="r"><code>head(as.data.frame(UCBAdmissions),n = 12)</code></pre>
<pre><code>##       Admit Gender Dept Freq
## 1  Admitted   Male    A  512
## 2  Rejected   Male    A  313
## 3  Admitted Female    A   89
## 4  Rejected Female    A   19
## 5  Admitted   Male    B  353
## 6  Rejected   Male    B  207
## 7  Admitted Female    B   17
## 8  Rejected Female    B    8
## 9  Admitted   Male    C  120
## 10 Rejected   Male    C  205
## 11 Admitted Female    C  202
## 12 Rejected Female    C  391</code></pre>
<pre class="r"><code>is_alluvia_form(as.data.frame(UCBAdmissions),axes = 1:3)</code></pre>
<pre><code>## [1] TRUE</code></pre>
<pre class="r"><code>ucb &lt;- as.data.frame(UCBAdmissions)
glimpse(ucb)</code></pre>
<pre><code>## Rows: 24
## Columns: 4
## $ Admit  &lt;fct&gt; Admitted, Rejected, Admitted, Rejected, Admitted, Rejected, Adm~
## $ Gender &lt;fct&gt; Male, Male, Female, Female, Male, Male, Female, Female, Male, M~
## $ Dept   &lt;fct&gt; A, A, A, A, B, B, B, B, C, C, C, C, D, D, D, D, E, E, E, E, F, ~
## $ Freq   &lt;dbl&gt; 512, 313, 89, 19, 353, 207, 17, 8, 120, 205, 202, 391, 138, 279~</code></pre>
<pre class="r"><code>ggplot(ucb, aes( y = Freq, axis1 = Gender, axis2 = Dept, axis3 = Admit)) +
  geom_alluvium(aes(fill = Gender),width = 1/12) + 
  geom_stratum(width = 1/5, fill = &quot;black&quot;, color = &quot;grey&quot;) +
  geom_label(stat = &quot;stratum&quot;, infer.label = TRUE) + 
  scale_x_discrete(limits = c(&quot;Gender&quot;,&quot;Dept&quot;, &quot;Admitted?&quot;),expand = c(0.05, 0.05))+
  scale_fill_brewer(type = &quot;qual&quot;, palette = &quot;Set1&quot;) +
  ggtitle(&quot;UC Berkeley admissions and rejections, by sex and department&quot;)</code></pre>
<pre><code>## Warning: The parameter `infer.label` is deprecated.
## Use `aes(label = after_stat(stratum))`.</code></pre>
<p><img src="/labs/Students-and-Alluvial_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<pre class="r"><code>titanic &lt;- as.data.frame(Titanic)
glimpse(titanic)</code></pre>
<pre><code>## Rows: 32
## Columns: 5
## $ Class    &lt;fct&gt; 1st, 2nd, 3rd, Crew, 1st, 2nd, 3rd, Crew, 1st, 2nd, 3rd, Crew~
## $ Sex      &lt;fct&gt; Male, Male, Male, Male, Female, Female, Female, Female, Male,~
## $ Age      &lt;fct&gt; Child, Child, Child, Child, Child, Child, Child, Child, Adult~
## $ Survived &lt;fct&gt; No, No, No, No, No, No, No, No, No, No, No, No, No, No, No, N~
## $ Freq     &lt;dbl&gt; 0, 0, 35, 0, 0, 0, 17, 0, 118, 154, 387, 670, 4, 13, 89, 3, 5~</code></pre>
<pre class="r"><code>ggplot(titanic,
       aes(y = Freq, # No of people defined by each category
           axis3 = Survived, axis2 = Sex, axis1 = Class)) + # Categories
  geom_alluvium(aes(fill = Class),
                # width = 0, knot.pos = 0, reverse = FALSE
                ) +
  guides(fill = FALSE) +
  geom_stratum( ) + #width = 1/3, reverse = FALSE) +
  geom_text(stat = &quot;stratum&quot;, aes(label = after_stat(stratum))) + #infer.label = TRUE, reverse = FALSE) +
  scale_x_continuous(breaks = 1:3, labels = c(&quot;Class&quot;,&quot;Sex&quot;, &quot;Survived&quot;)) +
  # coord_flip() +
  ggtitle(&quot;Titanic survival by class and sex&quot;)</code></pre>
<pre><code>## Warning: `guides(&lt;scale&gt; = FALSE)` is deprecated. Please use `guides(&lt;scale&gt; =
## &quot;none&quot;)` instead.</code></pre>
<p><img src="/labs/Students-and-Alluvial_files/figure-html/Titanic%20Alluvial%20Plot-1.png" width="672" /></p>
<pre class="r"><code>data(&quot;majors&quot;)
majors</code></pre>
<pre><code>##    student semester  curriculum
## 1        1    CURR1    Painting
## 2        2    CURR1    Painting
## 3        6    CURR1    Sculpure
## 4        8    CURR1    Painting
## 5        9    CURR1    Sculpure
## 6       10    CURR1    Painting
## 7       11    CURR1 Digital Art
## 8       12    CURR1    Sculpure
## 9       14    CURR1     Ceramic
## 10      15    CURR1 Photography
## 11       1    CURR3    Painting
## 12       2    CURR3    Painting
## 13       6    CURR3    Sculpure
## 14       8    CURR3    Painting
## 15       9    CURR3 Art History
## 16      10    CURR3    Painting
## 17      11    CURR3 Digital Art
## 18      12    CURR3    Sculpure
## 19      14    CURR3     Ceramic
## 20      15    CURR3 Photography
## 21       1    CURR5    Painting
## 22       2    CURR5    Painting
## 23       6    CURR5    Painting
## 24       8    CURR5    Painting
## 25       9    CURR5 Art History
## 26      10    CURR5    Painting
## 27      11    CURR5 Digital Art
## 28      12    CURR5    Sculpure
## 29      14    CURR5    Painting
## 30      15    CURR5 Photography
## 31       1    CURR7    Painting
## 32       2    CURR7    Painting
## 33       6    CURR7    Painting
## 34       8    CURR7    Painting
## 35       9    CURR7    Painting
## 36      10    CURR7    Painting
## 37      11    CURR7 Digital Art
## 38      12    CURR7    Sculpure
## 39      14    CURR7    Painting
## 40      15    CURR7    Painting
## 41       1    CURR9    Painting
## 42       2    CURR9    Painting
## 43       6    CURR9    Painting
## 44       8    CURR9        &lt;NA&gt;
## 45       9    CURR9    Painting
## 46      10    CURR9    Painting
## 47      11    CURR9 Digital Art
## 48      12    CURR9    Painting
## 49      14    CURR9    Painting
## 50      15    CURR9    Painting
## 51       1   CURR11    Painting
## 52       2   CURR11    Painting
## 53       6   CURR11    Painting
## 54       8   CURR11    Painting
## 55       9   CURR11    Painting
## 56      10   CURR11    Painting
## 57      11   CURR11    Painting
## 58      12   CURR11    Painting
## 59      14   CURR11    Painting
## 60      15   CURR11    Painting
## 61       1   CURR13    Painting
## 62       2   CURR13        &lt;NA&gt;
## 63       6   CURR13    Painting
## 64       8   CURR13    Painting
## 65       9   CURR13    Painting
## 66      10   CURR13        &lt;NA&gt;
## 67      11   CURR13    Painting
## 68      12   CURR13    Painting
## 69      14   CURR13    Painting
## 70      15   CURR13    Painting
## 71       1   CURR15    Painting
## 72       2   CURR15        &lt;NA&gt;
## 73       6   CURR15    Painting
## 74       8   CURR15    Painting
## 75       9   CURR15    Painting
## 76      10   CURR15        &lt;NA&gt;
## 77      11   CURR15    Painting
## 78      12   CURR15    Painting
## 79      14   CURR15    Painting
## 80      15   CURR15        &lt;NA&gt;</code></pre>
<pre class="r"><code>set.seed(1234)
majors$curriculum &lt;- as.factor(majors$curriculum)
glimpse(majors)</code></pre>
<pre><code>## Rows: 80
## Columns: 3
## $ student    &lt;int&gt; 1, 2, 6, 8, 9, 10, 11, 12, 14, 15, 1, 2, 6, 8, 9, 10, 11, 1~
## $ semester   &lt;fct&gt; CURR1, CURR1, CURR1, CURR1, CURR1, CURR1, CURR1, CURR1, CUR~
## $ curriculum &lt;fct&gt; Painting, Painting, Sculpure, Painting, Sculpure, Painting,~</code></pre>
<pre class="r"><code>ggplot(majors, aes(x = semester,
                   stratum = curriculum, 
                   alluvium = student, 
                   fill = curriculum, 
                   label = curriculum)) + 
  geom_flow(stat = &quot;alluvium&quot;, color = &quot;darkgrey&quot;) +
  geom_stratum()+
  scale_fill_brewer(type = &quot;qual&quot;, palette = &quot;Set2&quot;) +
  theme(legend.position = &quot;bottom&quot;) +
  ggtitle(&quot;student curricula across several semesters&quot;)</code></pre>
<p><img src="/labs/Students-and-Alluvial_files/figure-html/So%20what%20are%20the%20most%20popular%20courses-1.png" width="672" /></p>
<pre class="r"><code>GSK &lt;- c(&quot;VTT&quot;, &quot;DTT&quot;, &quot;SCT&quot;, &quot;DM&quot;)
CE &lt;- c(&quot;P&amp;I&quot;, &quot;O&amp;C&quot;, &quot;B&amp;C&quot;, &quot;C&amp;P&quot;, &quot;F&amp;S&quot;)
# CE2 &lt;- c(&quot;CE21&quot;, &quot;CE22&quot;, &quot;CE23&quot;, &quot;CE24&quot;)
# CE3 &lt;- c(&quot;CE31&quot;, &quot;CE32&quot;, &quot;CE33&quot;, &quot;CE34&quot;)
# CE4 &lt;- c(&quot;CE41&quot;, &quot;CE42&quot;, &quot;CE43&quot;, &quot;CE44&quot;)
Majors &lt;- c(&quot;CAP&quot;, &quot;DMA&quot;, &quot;Film&quot;, &quot;HCD&quot;, &quot;IADP&quot;, &quot;IAIDP&quot;, &quot;PSD&quot;, &quot;VCSB&quot;)

data &lt;- tibble(
  student = 1:100,
  Major = sample(Majors, size = 100, replace = TRUE),
  S1GSK = sample(GSK, size = 100, replace = TRUE),
  S1C1 = sample(CE, size = 100, replace = TRUE),
  S1C2 = sample(CE, size = 100, replace = TRUE),
  S2GSK = sample(GSK, size = 100, replace = TRUE),
  S2C1 = sample(CE, size = 100, replace = TRUE),
  S2C2 = sample(CE, size = 100, replace = TRUE)
)

data &lt;- data %&gt;% 
  pivot_longer(cols = c(S1GSK, S1C1,S1C2,S2GSK, S2C1,S2C2), names_to = &quot;cycle&quot;, values_to = &quot;class&quot;)
glimpse(data)</code></pre>
<pre><code>## Rows: 600
## Columns: 4
## $ student &lt;int&gt; 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 4, 4, 4,~
## $ Major   &lt;chr&gt; &quot;HCD&quot;, &quot;HCD&quot;, &quot;HCD&quot;, &quot;HCD&quot;, &quot;HCD&quot;, &quot;HCD&quot;, &quot;VCSB&quot;, &quot;VCSB&quot;, &quot;VCS~
## $ cycle   &lt;chr&gt; &quot;S1GSK&quot;, &quot;S1C1&quot;, &quot;S1C2&quot;, &quot;S2GSK&quot;, &quot;S2C1&quot;, &quot;S2C2&quot;, &quot;S1GSK&quot;, &quot;S1~
## $ class   &lt;chr&gt; &quot;DM&quot;, &quot;B&amp;C&quot;, &quot;O&amp;C&quot;, &quot;DTT&quot;, &quot;P&amp;I&quot;, &quot;P&amp;I&quot;, &quot;VTT&quot;, &quot;B&amp;C&quot;, &quot;F&amp;S&quot;, ~</code></pre>
<pre class="r"><code>is_alluvia_form(data)</code></pre>
<pre><code>## Missing alluvia for some stratum combinations.</code></pre>
<pre><code>## [1] TRUE</code></pre>
<pre class="r"><code>ggplot(data = data, aes(x = cycle, stratum = class, alluvium = student, fill = class,label = class)) +
  geom_alluvium(color = &quot;darkgrey&quot;) +
  geom_stratum() +
  geom_label(stat = &quot;stratum&quot;, label.strata = TRUE)</code></pre>
<pre><code>## Warning: Computation failed in `stat_stratum()`:
## The parameter `label.strata` is defunct.
## use `aes(label = after_stat(stratum))`.</code></pre>
<pre><code>## Warning in f(...): Some differentiation aesthetics vary within alluvia, and will be diffused by their first value.
## Consider using `geom_flow()` instead.</code></pre>
<p><img src="/labs/Students-and-Alluvial_files/figure-html/Lets_plot_this-1.png" width="672" /></p>
<pre class="r"><code>ggplot(data,
       aes(x = cycle, stratum = class, alluvium = student,
           fill = class, label = class)) +
  geom_flow(stat = &quot;alluvium&quot;, lode.guidance = &quot;rightleft&quot;,
            color = &quot;darkgray&quot;) +
  geom_stratum() +
  # theme(legend.position = &quot;none&quot;) +
  theme_minimal() + 
  geom_label(stat = &quot;stratum&quot;) + 
  ggtitle(&quot;Student Curricula across several Cycles&quot;)</code></pre>
<p><img src="/labs/Students-and-Alluvial_files/figure-html/Lets_plot_this-2.png" width="672" /></p>
<p>Can we plot Alluvial Diagrams on a per Major basis? Then I can see if students in each major have multiple pathways through the FSP CE courses</p>
<pre class="r"><code>## Can use &quot;purrr&quot; here. 

data %&gt;% filter(Major == &quot;HCD&quot;) %&gt;% 
  ggplot(.,
       aes(x = cycle, stratum = class, alluvium = student,
           fill = class, label = class)) +
  geom_flow(stat = &quot;alluvium&quot;, lode.guidance = &quot;rightleft&quot;,
            color = &quot;darkgray&quot;) +
  geom_stratum() +
  # theme(legend.position = &quot;none&quot;) +
  theme_minimal() + 
  geom_label(stat = &quot;stratum&quot;) + 
  ggtitle(&quot;HCD Student CE Pathways across several Cycles&quot;)</code></pre>
<p><img src="/labs/Students-and-Alluvial_files/figure-html/Per_Major_Alluvia-1.png" width="672" /></p>
</div>
